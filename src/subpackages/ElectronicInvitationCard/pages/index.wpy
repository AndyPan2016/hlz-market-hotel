<!--
  电子请柬首页
  @Author: zongxunjiang
  @CreateDate: 2019年6月4日13:55:25
  @LastUpdateDate: 2019年6月4日13:55:29
  @Remarks: 电子请柬首页
-->

<!-- 页面样式 -->
<style lang="less">
@base64-ico1: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAAYCAYAAAAYl8YPAAACLUlEQVRIS72UP0xTURTGf1/7kKCDJAyikIiJDkTzaGRyMNYEDVowxMHNSUcdHJ0AJ+OEcdVZRwi0ShiscTVKG4jRmAhqFBeoA4h55R1zWwGhfx4Jxjfe+93fO+fc77uixme9iQ7iNogYAJqBAsYoaxrWs+m5asdUbdEuHk8Q857/gWyXFAiLZ5WZnd6+UQGzgUQzRftYA7R+voCnIxqdLvwNrIT1+UOgwVrtb67bsCbyQ1GwLOjMDmAvNJFP1oeluuYQhyNhxrzSuY7/WNlOZ2Z2S+n8SP3K3G0G5lrdX7NV4wcN6oi8TQco+UxetirQgayY3JHP1qspJyB0NkmWLsSYRzaKFxvaXtH6meoJ6PdPEtKL1tI0zc7w88RpmmZesuJ3At1YkFXm7XzdBFh3dwOtwROkyyVhEBzDvG808J2AA+yRy+gXjAC4y3LujrIUKyqzC0cbie0bR5zb+GNQbCFGK3FvFoWdxOMLFG1pY9+YIlzu19MPv9zaRpuW8seQLm0pPeQ2mdw9Ul0LpHOtpPwrSI+3aMzGlM67l6UMs5R/DelhhRXMtWD3MQvA3qD4COJgpc6uK51/JDvV3kRLy9eIV6J+usyWWFxsk/V13QAeRGYxWnDTwSaB89HaCIXZpCzlf0Zq3zUM++Rgq0iNu4aZrTrYFFLPP4C9krnomMaBQ7sArkDYU/aZc7/2XkWlULeBlc1s8oB2hJtpfNP55kbzDmMG8ZqQCWVy738DdqzZScH9xq0AAAAASUVORK5CYII=';
@base64-ico2: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABsAAAAYCAYAAAALQIb7AAADjUlEQVRIS52WW2hcZRSFv3XOmVwaGvGCpL55DZpkBklB6YvFYFsyo+1DWytaSfGpolRFJBRRWpFW9MEWC+2D1HhpNFFRnGlpRQwVS0CDZNIKKtYXhbx4iSYZY+acLWfSmcx05kxG99Nw9lr/mn/vtTe/KAtL9twAzpPI1oISQCvYOKYjTHvvaWJisRxf/G398TuQnkLWB7oaI8SNgB1TJvtFEacSIRXfg/ESUnOtA4GvmM3frbELsyXOtq4m5t0RpM0RHDBeU2by8TBfELNk4jnEvkhCKWHjKNanTybmrbc3xpr8h0CqAd5epbMHZBtvu4lY7IeVCZcQZmeJOZtZtBHEPY3xLGAx3ylL9hxGTuGaDYcxg7iiYXwBaIdlyXgWqee/Ef8H2vhelkrMAatq0s0MMQ50gK6PlrCfgGmMO5FKpqvAG4vhzWaR2mqL8TSBfYn/5x947RuQ9leUz+w3pOf5/ZchrlzTjTnrEK9EnFUQm0Lqrgnw/R247rsYeWQvk/vrEC3tA8haMeWYmznGqvatODoAXEOQ34rjvR9RpYuh2F7EhhoAHxgCDS3n7DvyC9txm2/HX/gGr+UE0LU8GexEPAJWXUrj09r1Lbo8FX+4Uiw0VX4QeQfxg0Fc5+BlfdmpzOTbUb0tDvXryG6sApl/HHlvlH3PEQSbkLMe+Wcx5xRSSymftwE8dlWfw7fKZB9dEkvdejM0jQHXVQCLPQhdCW+yuLAPYnli6gQuMjfv0Na2H+kBQkz4R1z39GW3nSHwe3Xq/I/Lu7E/cQuOnSss0lIED2FOM77/NfJW4wbD4N+LuWkI7gf3Hcx24MgI7CqwDhzn+HIP7W8I+pQ5fy78VtEzS3UlwAsTxbnLYXYEcS1WaP7PGM8gDRMEW5COXsq9hfQr2GOgpqWFETqYpNKTZ4riVQaxVPd6cE6XSJU1OQRsAnViNoVsBJwXqg1hAQHbdTL7QXmuphutP5HCsY9BTqWWTSN1lI3CZ5juQniVvQ526eRUubEK6UjrW3/PQEX9o/xcbb0nlM6GFaiK+nPWnxjEIdwOjYXZi8pkn40C1xVbGov4q6A9K6vZUaWzu+vhVhQrCCbjJwqzFBVmw2SyDyr0YJ1oTGwbLrnERxFPgDStk1s0SrhL60ZDYoXbFR433ueIdWUnjtGa36jRC/+sJFTXjbXIdl/navzmDNJasFEU2x0+fhoRCjH/AiMHU0bMkeVmAAAAAElFTkSuQmCC';
.index-pages {
  height: 100%;
  .popup-foot {
    height: 100rpx;
    border: none;
    .popup-button-slot {
      width: 100%;
      position: relative;
      .button-cancel {
        float: left;
        width: 50%;
        height: 100rpx;
        line-height: 100rpx;
        text-align: center;
        color: #ff4c2f;
      }
      .button-sure {
        position: absolute;
        left: 50%;
        right: 0;
        height: 100rpx;
        top: 0;
        line-height: 100rpx;
        text-align: center;
        color: #fff;
        background: #ff4c2f;
      }
    }
  }
}
.scoll-pages {
  width: 100%;
  height: calc(100% - 128rpx);
  position: absolute;
  width: 100%;
}
.page-index-main {
  text-align: center;
  .no-data {
    position: absolute;
    left: 0;
    width: 100%;
    top: 29%;
    .text {
      color: #888;
      font-size: 30rpx;
      padding-top: 40rpx;
    }
    .bg {
      width: 278rpx;
      height: 222rpx;
    }
  }

  .list {
    padding: 22rpx;
    display: flex;
    flex-wrap: wrap;
    padding-bottom: 180rpx;
    .cell {
      width: 48%;
      margin-bottom: 22rpx;
      margin-right: 20rpx;
      height: 554rpx;
      position: relative;
      box-shadow: 0 6rpx 12rpx #f6f6f6;
      border: 2rpx solid #f00;
      display: flex;
      flex-direction: column;
      position: relative;
      .top {
        display: flex;
        flex: 1;
        position: relative;
      }
      .delete {
        position: absolute;
        width: 50rpx;
        height: 50rpx;
        background: url('https://media.ihunlizhe.com/market/ElectronicInvitationCard/assets/images/dele.jpg')
          0 0 no-repeat;
        background-size: 100% auto;
        top: 8rpx;
        right: 8rpx;
        z-index: 10;
      }
    }
    .even {
      margin-right: 0;
    }

    .flowery {
      .top {
        background: url('https://media.ihunlizhe.com/market/ElectronicInvitationCard/assets/images/flower/flower_list_bg.png')
          0 0 no-repeat;
        background-size: 100% auto;
        .photo {
          position: absolute;
          left: 50%;
          top: 50%;
          height: 180rpx;
          width: 180rpx;
          margin-left: -90rpx;
          margin-top: -118rpx;
          -webkit-mask-box-image: url('https://media.ihunlizhe.com/market/ElectronicInvitationCard/assets/images/flower/flower_box1_img_effect.png');
          -webkit-mask-repeat: no-repeat;
          -webkit-mask-size: 100% 100%;
          image {
            height: 100%;
            width: 100%;
          }
        }
        .name {
          position: absolute;
          left: 15%;
          top: 390rpx;
          width: 70%;
          height: 30rpx;
          font-size: 24rpx;
          color: #c34355;
          display: flex;
          justify-content: space-between;
          .lt {
            width: 100rpx;
            height: 30rpx;
            font-family: 'hy';
            text-align: right;
          }
          .ct {
            height: 30rpx;
            width: 30rpx;
            margin-top: -4rpx;
          }
          .rt {
            width: 100rpx;
            height: 30rpx;
            font-family: 'hy';
            text-align: left;
          }
        }
        .time {
          position: absolute;
          left: 0%;
          top: 425rpx;
          width: 100%;
          height: 30rpx;
          font-size: 20rpx;
          color: #555;
        }
        .address {
          position: absolute;
          left: 10%;
          top: 455rpx;
          width: 80%;
          height: 30rpx;
          font-size: 20rpx;
          color: #555;
        }
      }
    }
    .simplesong {
      .photo {
        display: none;
      }
      .top {
        background: url('https://media.ihunlizhe.com/market/ElectronicInvitationCard/invitation_template/template_post4.png')
          0 0 no-repeat;
        background-size: 100% auto;
        .name {
          .lt,
          .rt {
            position: absolute;
            width: 100%;
            text-align: center;
            font-family: 'hy';
            font-size: 20rpx;
          }
          .lt {
            top: 73rpx;
          }
          .rt {
            top: 134rpx;
          }
        }
        .time,
        .address {
          position: absolute;
          width: 100%;
          text-align: center;
          font-family: 'hy';
          font-size: 16rpx;
        }
        .time {
          top: 170rpx;
        }
        .address {
          top: 194rpx;
        }
      }
      .ct {
        display: none;
      }
    }
    .qinlan {
      .top {
        background: url('https://media.ihunlizhe.com/market/ElectronicInvitationCard/assets/blue/images/frame01.png')
          0 0 no-repeat;
        background-size: 100% auto;
        .photo {
          z-index: -1;
          position: absolute;
          width: 100%;
          padding: 0 42rpx;
          box-sizing: border-box;
          margin-top: 72rpx;
          .photo-outter {
            width: 100%;
            padding-bottom: 94.9%;
            height: 0;
            position: relative;
            .photo-wrapper {
              width: 100%;
              height: 100%;
              position: absolute;
              image {
                -webkit-mask-box-image: url('https://media.ihunlizhe.com/market/ElectronicInvitationCard/assets/blue/images/mask01_top.png');
                -webkit-mask-repeat: no-repeat;
                -webkit-mask-size: 100% auto;
                -webkit-mask-position: top center;
                height: 100%;
                width: 100%;
              }
            }
          }
        }
        .name {
          position: absolute;
          left: 15%;
          top: 360rpx;
          width: 70%;
          height: 30rpx;
          font-size: 24rpx;
          color: #ae783f;
          display: flex;
          justify-content: space-between;
          .lt {
            width: 100rpx;
            height: 30rpx;
            font-family: 'hy';
            text-align: right;
          }
          .ct {
            height: 30rpx;
            width: 30rpx;
            font-family: 'hy';
          }
          .rt {
            width: 100rpx;
            height: 30rpx;
            font-family: 'hy';
            text-align: left;
          }
        }
        .time {
          position: absolute;
          left: 0%;
          top: 395rpx;
          width: 100%;
          height: 30rpx;
          font-size: 20rpx;
          color: #555;
        }
        .address {
          position: absolute;
          left: 10%;
          top: 425rpx;
          width: 80%;
          height: 30rpx;
          font-size: 20rpx;
          color: #555;
        }
      }
    }
    .withyou {
      .top {
        .name {
          display: none;
        }
        .time {
          display: none;
        }
        .address {
          display: none;
        }
        .photo {
          width: 100%;
          height: 100%;
          overflow: hidden;
          .photo-outter {
            position: relative;
            overflow: hidden;
            width: 750rpx;
            height: 1334rpx;
            margin-left: -208rpx;
            margin-top: -192rpx;
          }
        }
      }
    }
    .baby {
      .top {
        .name {
          display: none;
        }
        .time {
          display: none;
        }
        .address {
          display: none;
        }
        .photo {
          width: 100%;
          height: 100%;
          overflow: hidden;
          .photo-outter {
            position: relative;
            overflow: hidden;
            width: 750rpx;
            height: 1334rpx;
            margin-left: -208rpx;
            margin-top: -192rpx;
          }
        }
      }
    }
    .longevity {
      .top {
        background: url('https://media.ihunlizhe.com/market/ElectronicInvitationCard/invitation_template/template_longevity_post.png')
          0 0 no-repeat;
        background-size: 100% auto;
      }
      .birthda-address {
        position: absolute;
        color: #333333;
        font-weight: 100;
        left: 50%;
        top: 265rpx;
        font-size: 16rpx;
        text-align: center;
        width: 40%;
        transform: translateX(-50%);
      }
      .birthday-star {
        position: absolute;
        color: #333333;
        font-weight: 100;
        left: 50%;
        top: 380rpx;
        font-size: 20rpx;
        text-align: center;
        width: 40%;
        font-family: 'hy';
        transform: translateX(-50%);
      }
      .time,
      .name,
      .address {
        display: none;
      }
    }
    .bottom {
      width: 100%;
      height: 60rpx;
      line-height: 60rpx;
      display: flex;
      justify-content: center;
      .vs {
        width: 50%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        .ico1 {
          height: 24rpx;
          width: 20rpx;
          background: url('@{base64-ico1}') 0 0 no-repeat;
          background-size: cover;
        }
        .ico2 {
          height: 24rpx;
          width: 28rpx;
          background: url('@{base64-ico2}') 0 0 no-repeat;
          background-size: cover;
        }
        .text {
          display: inline-block;
          margin-left: 10rpx;
          font-size: 24rpx;
        }
      }
    }
  }
  .add-btn {
    position: fixed;
    bottom: 62rpx;
    left: 50%;
    width: 320rpx;
    height: 80rpx;
    margin-left: -160rpx;
    border-radius: 48rpx;
    background: #ff4c2f;
    line-height: 80rpx;
    text-align: center;
    font-size: 30rpx;
    color: #fff;
    box-shadow: 0 6rpx 50rpx rgba(255, 76, 47, 0.6);
    z-index: 100;
    .ico {
      height: 30rpx;
      width: 30rpx;
      position: absolute;
      left: 60rpx;
      top: 50%;
      margin-top: -15rpx;
    }
  }
}

.popup-cont-slot {
  margin-bottom: 80rpx;
  text-align: center;

  .delete-remark {
    margin-top: 40rpx;
    font-size: 24rpx;
    .red {
      color: #ff4c2f;
    }
  }
}
</style>

<!-- 页面模板 -->
<template>
  <view class="index-pages">
    <navigationBar :title="title"></navigationBar>
    <scroll-view class="scoll-pages" :class="{iphonex:iphoneX}" scroll-y bindscrolltolower="scollBtm">
      <view class="page-index-main">
        <!-- 没数据 -->
        <view class="no-data" wx:if='{{dataList.length == 0}}'>
          <image class="bg" src="https://media.ihunlizhe.com/market/ElectronicInvitationCard/assets/images/index_no_data_bg.png">
          </image>
          <view class="text">暂无电子请柬，赶快去创建吧！</view>
        </view>
        <!-- 有数据 -->
        <view class="list">
          <repeat for="{{dataList}}" key="index" index="idx" item="item">
            <!-- <view class="cell {{templateList[item.templateType]}}" :class="{even:idx%2!=0}" wx:for="{{dataList}}" wx:for-index="idx" wx:key="key"> -->
            <view class="cell {{templateList[item.templateType]}}" :class="{even:idx%2!=0}">
              <view class="delete" @tap="delInvitation" data-invitationId="{{item.invitationId}}" data-shareStatus="{{item.shareStatus}}"></view>
              <view class="top" @tap="linkToTemplate" data-type="setting" data-invitationId="{{item.invitationId}}" data-tpm="{{item}}">
                <view class="photo">
                  <block wx:if="{{templateList[item.templateType] == 'qinlan'}}">
                    <view class="photo-outter">
                      <view class="photo-wrapper">
                        <image src="{{ item.coverImage || 'https://media.ihunlizhe.com/market/ElectronicInvitationCard/assets/blue/images/photo01.png'}}">
                        </image>
                      </view>
                    </view>
                  </block>
                  <block wx:elif="{{templateList[item.templateType] == 'withyou'}}">
                    <view class="photo-outter">
                      <withyou-firstscreen scale="cover" :current="0" showSlot="true">
                        <image slot="photo-thumb" class="photo-thumb thumb-custom" src="{{item.coverImage || 'https://media.ihunlizhe.com/market/ElectronicInvitationCard/invitation_template/invitation_concise/photo-thumb-default-2/12.png'}}" />
                        <text slot="wedding-people" class="wedding-people">{{item.bridegroomName || '新郎'}} & {{item.brideName || '新娘'}}</text>
                        <text slot="wedding-date" class="wedding-date">{{item.weddingTime || '2019年12月12日 12时08分'}}</text>
                        <text slot="wedding-address" class="wedding-address">{{item.hotelName}}</text>
                      </withyou-firstscreen>
                    </view>
                  </block>
                  <block wx:elif="{{item.templateType == 'BABY'}}">
                    <view class="photo-outter">
                      <baby-firstscreen scale="cover" :current="0" showSlot="true">
                        <image slot="photo-thumb" class="photo-thumb" src="{{item.coverImage || 'https://media.ihunlizhe.com/market/ElectronicInvitationCard/invitation_template/invitation_baby/default-photo-1.png'}}" />
                        <view slot="info-baby-name" class="info-baby-name">{{item.babyName || '宝宝'}}{{item.babyBanquetTypeText}}</view>
                        <view slot="parent-name" class="parent-name">宝爸：{{item.babyDadName || '宝爸'}} | 宝妈：{{item.babyMomName || '宝妈'}}</view>
                        <view slot="screen-date" class="date">{{item.weddingTime || '2019年12月12日 12时08分'}}</view>
                        <view slot="screen-address" class="addresses">{{item.hotelName}}</view>
                      </baby-firstscreen>
                    </view>
                  </block>
                  <block wx:elif="{{item.templateType == 'LONGEVITY'}}">
                    <text class="birthda-address">{{item.hotelName||'国贸格兰维大酒店'}}\n{{item.weddingTime}}</text>
                    <text class="birthday-star">{{item.birthdayStar||'王大娘'}}\n{{item.birthdayAge || '80'}}岁寿辰</text>
                  </block>
                  <block wx:else>
                    <image src="{{ item.coverImage || 'https://media.ihunlizhe.com/market/ElectronicInvitationCard/assets/images/flower/flower_box1_img.png'}}">
                    </image>
                  </block>
                </view>
                <view class="name">
                  <view class="lt">{{item.bridegroomName}}</view>
                  <view class="ct">{{'&'}}</view>
                  <view class="rt">{{item.brideName}}</view>
                </view>
                <view class="time">{{item.weddingTime}}</view>
                <view class="address">{{item.hotelName}}</view>
              </view>
              <view class="bottom">
                <view class="vs" @tap="linkToGuest" data-item="{{item}}">
                  <view class="ico1"></view>
                  <text class="text">宾客</text>
                </view>
                <view class="vs" @tap="linkToGift" data-invitationId="{{item.invitationId}}" wx:if="{{item.supportGift === 'yes' && privilege}}">
                  <view class="ico2"></view>
                  <text class="text">伴手礼</text>
                </view>
              </view>
            </view>
          </repeat>
          <view class="add-btn" @tap="linkToTemplate" data-type="create">
            <image class="ico" src="https://media.ihunlizhe.com/market/ElectronicInvitationCard/assets/images/add_ico.png"></image>
            <view>创建请柬</view>
          </view>
          <!--授权-->
          <user-authorize :onAuthorizeAll="onAuthorizeAllFn" :authorizeType="authorizeType" :onCloseAuthorize="onCloseAuthorizeFn" />
        </view>
      </view>
    </scroll-view>
    <popup-tip :buttons="tipButtons" title="提示" titleTextAlign="center" :onSure="deleteSure">
      <view class="popup-cont-slot" slot="popup-body-cont">
        <view>确定删除？</view>
        <view wx:if="{{shareStatus === 'yes'}}" class="delete-remark">
          <text class="red">电子请柬已发送，</text>删除后，将无法查看请柬内容
        </view>
      </view>
      <view class="popup-button-slot" slot="popup-button-slot">
        <view class="button-cancel">取消</view>
        <view class="button-sure" data-key="sure">确定</view>
      </view>
    </popup-tip>
  </view>
</template>

<!-- 页面交互 -->
<script>
import wepy from 'wepy'
import UserAuthorizeComponent from '@/components/user-authorize-component/index'
import PopupComponent from '@/components/popup-component/index'
import { STATUS, LANG } from '@/configs'
import { IndexService, InvitationService } from '../services'
import { Tips, Utils, PATCH } from '@/utils'
import navigationBar from '../components/navigation-bar/index'
import WithYouFirstscreen from './invitation_template/invitation_withyou/components/page1'
import BabyFirstscreen from './invitation_template/invitation_baby/components/page1'

export default class IndexPages extends wepy.page {
  // 配置
  config = {
    navigationStyle: 'custom',
    backgroundTextStyle: 'light',
    navigationBarTextStyle: 'white',
    disableScroll: true
  }

  // data
  data = {
    title: '喜事宝',
    dataList: [],
    templateList: {
      FLOWERY: 'flowery',
      QINLAN: 'qinlan',
      SIMPLESONG: 'simplesong',
      WITHYOU: 'withyou',
      BABY: 'baby',
      LONGEVITY: 'longevity'
    },
    pageDatas: {
      baseInfo: {},
      imageInfo: {}
    },
    // 用户编号
    userNo: '',
    // 页码
    pageSize: 1,
    // 分页大小
    limit: 10,
    // 总页数
    totalPages: '',
    // 酒店ID
    hotelId: '',
    iphoneX: false,
    hotelType: '',
    // 提示按钮
    tipButtons: null,
    // tipButtons: [
    //   { type: 'default', key: 'cancel', text: '取消' },
    //   { type: 'warn', key: 'sure', text: '确定' }
    // ],
    // 当前删除请柬ID
    delInvitationId: '',
    // 当前删除请柬分享状态（yes | no）
    shareStatus: 'no',
    privilege: true
  }

  components = {
    'user-authorize': UserAuthorizeComponent,
    navigationBar: navigationBar,
    'popup-tip': PopupComponent,
    'withyou-firstscreen': WithYouFirstscreen,
    'baby-firstscreen': BabyFirstscreen
  }

  methods = {
    // 跳转到伴手礼
    linkToGift(e) {
      let invitationId = e.currentTarget.dataset.invitationid
      wx.navigateTo({
        url: 'gift?invitationId=' + invitationId
      })
    },
    // 跳转到宾客
    linkToGuest(e) {
      let invitationId = e.currentTarget.dataset.item.invitationId || ''
      wx.navigateTo({ url: 'guest?invitationId=' + invitationId })
    },
    // 跳转到模版页面
    linkToTemplate(e) {
      let type = e.currentTarget.dataset.type
      let invitationid = e.currentTarget.dataset.invitationid || ''
      let tpmdata = e.currentTarget.dataset.tpm || ''
      let themetype = ''
      let tplId
      let tpltype
      if (tpmdata) {
        tpltype = e.currentTarget.dataset.tpm.templateType
        themetype = tpmdata.themeType
        tplId = tpmdata.templateId
        tpltype = tpltype.toLowerCase()
      }
      if (invitationid) {
        // 测试模板跳转
        // tpltype = 'dianya'
        wx.navigateTo({
          url:
            'invitation_template/invitation_' +
            tpltype +
            '/index?bottomType=' +
            type +
            '&hotelId=' +
            this.hotelId +
            '&hotelType=' +
            this.hotelType +
            '&invitationid=' +
            invitationid +
            '&templateType=' +
            tpltype +
            '&themetype=' +
            themetype +
            '&tpl_id=' +
            tplId +
            '&tpmdata=' +
            JSON.stringify(tpmdata)
        })
      } else {
        wx.navigateTo({
          url: 'templates-list'
        })
      }
    },

    /**
     * 滚动到底部
     */
    scollBtm() {
      if (this.totalPages >= this.pageSize) {
        this.getList()
      }
    },
    /**
     * 删除电子请柬
     */
    delInvitation(e) {
      let dataset = e.currentTarget.dataset
      this.delInvitationId = dataset.invitationid || ''
      this.shareStatus = dataset.sharestatus
      this.$apply()
      this.$invoke('popup-tip', 'open')
    }
  }

  /**
   * 删除确认
   */
  deleteSure() {
    this.deleteInvitation(this.delInvitationId)
  }

  /**
   * 删除电子请柬
   */
  deleteInvitation(invitationId) {
    InvitationService.invitationDelete({
      data: {
        invitationId: invitationId
      }
    })
      .then(res => {
        let data = res.data
        if (data.success) {
          this.pageSize = 1
          this.limit = 10
          this.$apply()
          this.getList()
        } else {
          Tips.error(res.message)
        }
      })
      .catch(err => {
        Tips.error(err.message)
      })
  }

  initTimes(e) {
    console.log(e)
  }
  // 加载完成
  onLoad(options) {
    PATCH.createPatch.call(this)
    let hotelId = options.hotelId
    let hotelType = options.hotelType
    if (hotelId) {
      this.hotelId = hotelId
      wx.setStorageSync('Invitation' + STATUS.HOTEL_ID, hotelId)
    }
    if (hotelType) {
      this.hotelType = hotelType
      wx.setStorageSync('Invitation' + STATUS.HOTEL_TYPE, hotelType)
      wx.setStorageSync('Invitation' + STATUS.HOTEL_TYPE, hotelType)
    }
    this.checkPrivilege({
      hotelId: this.hotelId,
      moduleTypeEnum: 'INVITATION_GIFT'
    })
  }
  onShow() {
    let userNo = wepy.getStorageSync(STATUS.USER_NO)
    if (userNo) {
      this.userNo = userNo
      this.pageSize = 1
      this.getList()
    } else {
      this.$invoke('user-authorize', 'authorizeActivation')
    }
  }
  /**
   * 授权完成回调
   */
  onAuthorizeAllFn() {
    this.userNo = wepy.getStorageSync(STATUS.USER_NO)
    if (this.userNo) {
      this.getList()
      // wepy.navigateTo({ url: 'goods-order' })
    }
    this.$apply()
  }
  /**
   * 授权失败回调
   */
  onCloseAuthorize() {
    return false
  }

  /**
   * 获取请柬列表
   */
  getList(parme) {
    let parmes = {}
    parmes['userNo'] = this.userNo
    parmes['start'] = this.pageSize
    parmes['limit'] = this.limit
    parmes['hotelId'] = this.hotelId
    IndexService.myInvitationPageListQuery({ data: parmes })
      .then(res => {
        let data = res.data
        if (data.success) {
          this.totalPages = Math.ceil(data.totalRows / this.limit)
          Utils.forEach(data.rows, row => {
            // 去掉日期中的秒
            row.weddingTime = row.weddingTime.substring(
              0,
              row.weddingTime.lastIndexOf(':')
            )
            if (row.babyBanquetType) {
              row['babyBanquetTypeText'] =
                (LANG.couponType[row.babyBanquetType] || {}).text || ''
            }
          })
          if (this.pageSize === 1) {
            this.dataList = data.rows
          } else {
            Utils.forEach(data.rows, row => {
              this.dataList.push(row)
            })
          }
          this.pageDatas.baseInfo = this.dataList
          this.pageSize++
          this.$apply()
        }
      })
      .catch(err => {
        Tips.error(err)
      })
  }
  /**
   * 权限判断
   */
  checkPrivilege(parme) {
    let parmes = Object.assign({}, parme)
    InvitationService.modulePrivilegeCheck({ data: parmes })
      .then(res => {
        let result = res.data
        if (result.success) {
          this.privilege = true
        } else {
          this.privilege = false
        }
        this.$apply()
      })
      .catch(() => {
        this.privilege = false
        this.$apply()
      })
  }
}
</script>
